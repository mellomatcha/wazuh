<!--
=================================================================
WAZUH ZEEK RULES - FIELD NORMALIZED VERSION
=================================================================
File: /var/ossec/etc/rules/zeek_rules.xml

SOLUTION:
- Gunakan generic JSON decoder (sudah built-in Wazuh)
- Field diakses dengan nama asli dari JSON (tanpa prefix data.)
- Untuk visualisasi: gunakan field asli JSON, bukan extracted field

KENAPA INI BERHASIL:
- Generic JSON decoder sudah parse semua field
- Field langsung accessible: id.orig_h, mime_type, query, dll
- Tidak perlu custom decoder yang rumit

TESTED: Real Zeek logs dari production
=================================================================
-->

<group name="zeek,zeek_custom,">

  <!-- ============================================================ -->
  <!-- PARENT RULES - Identifikasi Log Type -->
  <!-- ============================================================ -->

  <!-- Parent 1: Session Logs (dengan UID) -->
  <rule id="100300" level="3">
    <decoded_as>json</decoded_as>
    <field name="uid">\.+</field>
    <description>Zeek: Session Event</description>
    <options>no_full_log</options>
  </rule>

  <!-- Parent 2: Infrastructure - Capture Loss -->
  <rule id="100307" level="5">
    <decoded_as>json</decoded_as>
    <field name="percent_lost">\.+</field>
    <field name="peer">zeek</field>
    <description>Zeek: Capture Loss Event</description>
    <group>zeek_capture_loss,</group>
  </rule>

  <!-- Parent 3: Infrastructure - Software -->
  <rule id="100308" level="3">
    <decoded_as>json</decoded_as>
    <field name="software_type">\.+</field>
    <description>Zeek: Software Detected</description>
    <group>zeek_software,</group>
  </rule>

  <!-- Parent 4: Infrastructure - X509 -->
  <rule id="100306" level="3">
    <decoded_as>json</decoded_as>
    <field name="certificate.subject">\.+</field>
    <description>Zeek: X509 Certificate</description>
    <group>zeek_x509,</group>
  </rule>

  <!-- Parent 5: Infrastructure - Known Services -->
  <rule id="100305" level="3">
    <decoded_as>json</decoded_as>
    <field name="port_num">\.+</field>
    <field name="port_proto">\.+</field>
    <description>Zeek: Known Service</description>
    <group>zeek_known_services,</group>
  </rule>

  <!-- ============================================================ -->
  <!-- 1. NOTICE.LOG - CRITICAL ALERTS -->
  <!-- ============================================================ -->

  <rule id="100400" level="10">
    <if_sid>100300</if_sid>
    <field name="note">\.+</field>
    <description>Zeek Notice: Security Alert</description>
    <group>zeek_notice,ids,</group>
  </rule>

  <rule id="100401" level="12">
    <if_sid>100400</if_sid>
    <field name="note">Scan::</field>
    <description>Zeek Notice: Network Scan Detected</description>
    <group>zeek_notice,reconnaissance,pci_dss_11.4,</group>
  </rule>

  <rule id="100402" level="12">
    <if_sid>100400</if_sid>
    <field name="note">SSH::Password_Guessing</field>
    <description>Zeek Notice: SSH Brute Force</description>
    <group>zeek_notice,brute_force,pci_dss_10.2.4,</group>
  </rule>

  <rule id="100403" level="10">
    <if_sid>100400</if_sid>
    <field name="note">SSL::Invalid_Server_Cert</field>
    <description>Zeek Notice: Invalid SSL Certificate</description>
    <group>zeek_notice,ssl,pci_dss_10.6.1,</group>
  </rule>

  <rule id="100404" level="12">
    <if_sid>100400</if_sid>
    <field name="note">Intel::Notice</field>
    <description>Zeek Notice: Threat Intel Match</description>
    <group>zeek_notice,threat_intel,pci_dss_11.4,</group>
  </rule>

  <!-- ============================================================ -->
  <!-- 2. DNS.LOG -->
  <!-- ============================================================ -->

  <rule id="100410" level="3">
    <if_sid>100300</if_sid>
    <field name="query">\.+</field>
    <field name="qtype_name">\.+</field>
    <description>Zeek DNS: Query</description>
    <group>zeek_dns,dns,</group>
  </rule>

  <rule id="100411" level="5">
    <if_sid>100410</if_sid>
    <field name="rcode_name">NXDOMAIN</field>
    <description>Zeek DNS: Non-Existent Domain</description>
    <group>zeek_dns,dns_error,</group>
  </rule>

  <rule id="100412" level="7">
    <if_sid>100410</if_sid>
    <field name="qtype_name">^TXT$</field>
    <description>Zeek DNS: TXT Query (Possible Tunneling)</description>
    <group>zeek_dns,data_exfiltration,</group>
  </rule>

  <rule id="100413" level="7">
    <if_sid>100410</if_sid>
    <field name="rejected">true</field>
    <description>Zeek DNS: Query Rejected</description>
    <group>zeek_dns,blocked,</group>
  </rule>

  <!-- ============================================================ -->
  <!-- 3. HTTP.LOG -->
  <!-- ============================================================ -->

  <rule id="100420" level="3">
    <if_sid>100300</if_sid>
    <field name="method">GET</field>
    <field name="host">\.+</field>
    <description>Zeek HTTP: GET Request</description>
    <group>zeek_http,web,</group>
  </rule>

  <rule id="100421" level="3">
    <if_sid>100300</if_sid>
    <field name="method">POST</field>
    <description>Zeek HTTP: POST Request</description>
    <group>zeek_http,web,</group>
  </rule>

  <rule id="100422" level="5">
    <if_sid>100300</if_sid>
    <field name="method">\.+</field>
    <field name="status_code">^40\d$</field>
    <description>Zeek HTTP: 40x Client Error</description>
    <group>zeek_http,web_error,</group>
  </rule>

  <rule id="100423" level="7">
    <if_sid>100300</if_sid>
    <field name="method">\.+</field>
    <field name="status_code">^50\d$</field>
    <description>Zeek HTTP: 50x Server Error</description>
    <group>zeek_http,web_error,</group>
  </rule>

  <rule id="100424" level="10">
    <if_sid>100300</if_sid>
    <field name="user_agent">sqlmap</field>
    <description>Zeek HTTP: SQLMap Attack Tool</description>
    <group>zeek_http,web_attack,pci_dss_11.4,</group>
  </rule>

  <rule id="100425" level="10">
    <if_sid>100300</if_sid>
    <field name="user_agent">nikto</field>
    <description>Zeek HTTP: Nikto Scanner</description>
    <group>zeek_http,web_attack,pci_dss_11.4,</group>
  </rule>

  <!-- ============================================================ -->
  <!-- 4. FILES.LOG - CRITICAL UNTUK VISUALISASI -->
  <!-- ============================================================ -->

  <rule id="100430" level="3">
    <if_sid>100300</if_sid>
    <field name="fuid">^F</field>
    <field name="mime_type">\.+</field>
    <description>Zeek Files: File Transfer</description>
    <group>zeek_files,file_transfer,</group>
  </rule>

  <rule id="100431" level="7">
    <if_sid>100430</if_sid>
    <field name="mime_type">application/x-dosexec</field>
    <description>Zeek Files: Windows Executable</description>
    <group>zeek_files,executable,pci_dss_11.4,</group>
  </rule>

  <rule id="100432" level="7">
    <if_sid>100430</if_sid>
    <field name="mime_type">application/x-executable</field>
    <description>Zeek Files: Linux Executable</description>
    <group>zeek_files,executable,</group>
  </rule>

  <rule id="100433" level="5">
    <if_sid>100430</if_sid>
    <field name="mime_type">application/zip</field>
    <description>Zeek Files: Archive File</description>
    <group>zeek_files,archive,</group>
  </rule>

  <rule id="100434" level="7">
    <if_sid>100430</if_sid>
    <field name="mime_type">application/pdf</field>
    <description>Zeek Files: PDF Document</description>
    <group>zeek_files,document,</group>
  </rule>

  <rule id="100435" level="5">
    <if_sid>100430</if_sid>
    <field name="mime_type">application/x-sh</field>
    <description>Zeek Files: Shell Script</description>
    <group>zeek_files,script,</group>
  </rule>

  <!-- ============================================================ -->
  <!-- 5. SMB_MAPPING.LOG -->
  <!-- ============================================================ -->

  <rule id="100440" level="3">
    <if_sid>100300</if_sid>
    <field name="share_type">\.+</field>
    <field name="path">\.+</field>
    <description>Zeek SMB: Share Access</description>
    <group>zeek_smb,smb,</group>
  </rule>

  <rule id="100441" level="5">
    <if_sid>100440</if_sid>
    <field name="share_type">PIPE</field>
    <description>Zeek SMB: Named Pipe Access</description>
    <group>zeek_smb,lateral_movement,</group>
  </rule>

  <rule id="100442" level="7">
    <if_sid>100440</if_sid>
    <field name="path">ADMIN\$</field>
    <description>Zeek SMB: Admin Share Access</description>
    <group>zeek_smb,lateral_movement,pci_dss_10.6.1,</group>
  </rule>

  <rule id="100443" level="7">
    <if_sid>100440</if_sid>
    <field name="path">C\$</field>
    <description>Zeek SMB: C$ Share Access</description>
    <group>zeek_smb,lateral_movement,pci_dss_10.6.1,</group>
  </rule>

  <!-- ============================================================ -->
  <!-- 6. DCE_RPC.LOG -->
  <!-- ============================================================ -->

  <rule id="100450" level="3">
    <if_sid>100300</if_sid>
    <field name="endpoint">\.+</field>
    <field name="operation">\.+</field>
    <description>Zeek DCE-RPC: RPC Call</description>
    <group>zeek_dce_rpc,windows,</group>
  </rule>

  <rule id="100451" level="7">
    <if_sid>100450</if_sid>
    <field name="endpoint">samr</field>
    <description>Zeek DCE-RPC: SAM Remote (User Enumeration)</description>
    <group>zeek_dce_rpc,reconnaissance,</group>
  </rule>

  <rule id="100452" level="10">
    <if_sid>100450</if_sid>
    <field name="endpoint">drsuapi</field>
    <description>Zeek DCE-RPC: Directory Replication (DCSync)</description>
    <group>zeek_dce_rpc,credential_dumping,pci_dss_10.6.1,</group>
  </rule>

  <rule id="100453" level="7">
    <if_sid>100450</if_sid>
    <field name="endpoint">lsarpc</field>
    <description>Zeek DCE-RPC: LSA Remote (Privilege Enum)</description>
    <group>zeek_dce_rpc,reconnaissance,</group>
  </rule>

  <!-- ============================================================ -->
  <!-- 7. KERBEROS.LOG -->
  <!-- ============================================================ -->

  <rule id="100460" level="3">
    <if_sid>100300</if_sid>
    <field name="request_type">TGS</field>
    <description>Zeek Kerberos: TGS Request</description>
    <group>zeek_kerberos,authentication,</group>
  </rule>

  <rule id="100461" level="3">
    <if_sid>100300</if_sid>
    <field name="request_type">AS</field>
    <description>Zeek Kerberos: AS Request</description>
    <group>zeek_kerberos,authentication,</group>
  </rule>

  <rule id="100462" level="8">
    <if_sid>100460,100461</if_sid>
    <field name="success">false</field>
    <description>Zeek Kerberos: Authentication Failed</description>
    <group>zeek_kerberos,authentication_failed,pci_dss_10.2.4,</group>
  </rule>

  <rule id="100463" level="8">
    <if_sid>100460,100461</if_sid>
    <field name="cipher">rc4-hmac</field>
    <description>Zeek Kerberos: Weak Encryption (RC4)</description>
    <group>zeek_kerberos,weak_crypto,</group>
  </rule>

  <!-- ============================================================ -->
  <!-- 8. SSH.LOG -->
  <!-- ============================================================ -->

  <rule id="100470" level="3">
    <if_sid>100300</if_sid>
    <field name="client">^SSH-</field>
    <description>Zeek SSH: Connection</description>
    <group>zeek_ssh,ssh,</group>
  </rule>

  <rule id="100471" level="5">
    <if_sid>100470</if_sid>
    <field name="auth_success">true</field>
    <description>Zeek SSH: Successful Authentication</description>
    <group>zeek_ssh,authentication_success,</group>
  </rule>

  <rule id="100472" level="7">
    <if_sid>100470</if_sid>
    <field name="auth_success">false</field>
    <description>Zeek SSH: Failed Authentication</description>
    <group>zeek_ssh,authentication_failed,pci_dss_10.2.4,</group>
  </rule>

  <!-- ============================================================ -->
  <!-- 9. SSL.LOG -->
  <!-- ============================================================ -->

  <rule id="100510" level="3">
    <if_sid>100300</if_sid>
    <field name="version">^TLS</field>
    <field name="cipher">\.+</field>
    <description>Zeek SSL: TLS Connection</description>
    <group>zeek_ssl,ssl,</group>
  </rule>

  <rule id="100511" level="5">
    <if_sid>100510</if_sid>
    <field name="version">TLSv13</field>
    <description>Zeek SSL: TLS 1.3 (Secure)</description>
    <group>zeek_ssl,</group>
  </rule>

  <rule id="100512" level="7">
    <if_sid>100510</if_sid>
    <field name="version">TLSv1$</field>
    <description>Zeek SSL: Old TLS Version</description>
    <group>zeek_ssl,weak_crypto,pci_dss_4.1,</group>
  </rule>

  <rule id="100513" level="7">
    <if_sid>100510</if_sid>
    <field name="established">false</field>
    <description>Zeek SSL: Handshake Failed</description>
    <group>zeek_ssl,</group>
  </rule>

  <!-- ============================================================ -->
  <!-- 10. CONN.LOG -->
  <!-- ============================================================ -->

  <rule id="100550" level="3">
    <if_sid>100300</if_sid>
    <field name="conn_state">SF</field>
    <description>Zeek Conn: Normal Connection</description>
    <group>zeek_conn,network,</group>
  </rule>

  <rule id="100551" level="5">
    <if_sid>100300</if_sid>
    <field name="conn_state">REJ</field>
    <description>Zeek Conn: Connection Rejected</description>
    <group>zeek_conn,blocked,</group>
  </rule>

  <rule id="100552" level="5">
    <if_sid>100300</if_sid>
    <field name="conn_state">S0</field>
    <description>Zeek Conn: No Reply (Port Scan)</description>
    <group>zeek_conn,port_scan,</group>
  </rule>

  <!-- ============================================================ -->
  <!-- 11. RDP.LOG -->
  <!-- ============================================================ -->

  <rule id="100480" level="5">
    <if_sid>100300</if_sid>
    <field name="cookie">\.+</field>
    <field name="security_protocol">\.+</field>
    <description>Zeek RDP: Connection</description>
    <group>zeek_rdp,rdp,</group>
  </rule>

  <rule id="100481" level="7">
    <if_sid>100480</if_sid>
    <field name="result">encrypted</field>
    <description>Zeek RDP: Encrypted Session</description>
    <group>zeek_rdp,lateral_movement,</group>
  </rule>

  <!-- ============================================================ -->
  <!-- 12. SOFTWARE.LOG (Parent 100308) -->
  <!-- ============================================================ -->

  <rule id="100491" level="5">
    <if_sid>100308</if_sid>
    <field name="software_type">HTTP::BROWSER</field>
    <description>Zeek Software: Browser Detected</description>
    <group>zeek_software,</group>
  </rule>

  <rule id="100492" level="5">
    <if_sid>100308</if_sid>
    <field name="software_type">HTTP::SERVER</field>
    <description>Zeek Software: Web Server Detected</description>
    <group>zeek_software,</group>
  </rule>

  <!-- ============================================================ -->
  <!-- 13. X509.LOG (Parent 100306) -->
  <!-- ============================================================ -->

  <rule id="100521" level="5">
    <if_sid>100306</if_sid>
    <field name="basic_constraints.ca">true</field>
    <description>Zeek X509: CA Certificate</description>
    <group>zeek_x509,</group>
  </rule>

  <!-- ============================================================ -->
  <!-- 14. CAPTURE_LOSS.LOG (Parent 100307) -->
  <!-- ============================================================ -->

  <rule id="100531" level="8">
    <if_sid>100307</if_sid>
    <field name="percent_lost">^[5-9]\.</field>
    <description>Zeek Capture: High Packet Loss (5-9%)</description>
    <group>zeek_capture_loss,performance,</group>
  </rule>

  <rule id="100532" level="10">
    <if_sid>100307</if_sid>
    <field name="percent_lost">^[1-9][0-9]\.</field>
    <description>Zeek Capture: Critical Packet Loss (10%+)</description>
    <group>zeek_capture_loss,performance,</group>
  </rule>

  <!-- ============================================================ -->
  <!-- 15. KNOWN_SERVICES.LOG (Parent 100305) -->
  <!-- ============================================================ -->

  <rule id="100501" level="5">
    <if_sid>100305</if_sid>
    <field name="port_num">^22$</field>
    <description>Zeek Known Service: SSH</description>
    <group>zeek_known_services,</group>
  </rule>

  <rule id="100502" level="5">
    <if_sid>100305</if_sid>
    <field name="port_num">^3389$</field>
    <description>Zeek Known Service: RDP</description>
    <group>zeek_known_services,</group>
  </rule>

  <rule id="100503" level="5">
    <if_sid>100305</if_sid>
    <field name="port_num">^445$</field>
    <description>Zeek Known Service: SMB</description>
    <group>zeek_known_services,</group>
  </rule>

</group>
